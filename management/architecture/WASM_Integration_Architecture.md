 # WASM Integration Architecture

## 1  Scope
Explains **how WebAssembly (WASM) modules are built, loaded, and invoked** within RealMotionEngine (RME).  
Covers C++ source organisation, Emscripten build flags, JavaScript glue code, memory management, and the Worker invocation pattern.

---

## 2  Goals & Non-Goals
| Goals | Non-Goals |
| ----- | --------- |
| • Achieve sub-millisecond filter execution in browser | • Detailed math of each filter algorithm |
| • Provide a **plugin-style** interface for new modules | • Native mobile (iOS/Android) integration |
| • Keep bundle ≤ 400 kB per plugin (gzipped) | • SIMD / multithread specifics (future work) |

---

## 3  Build Pipeline
```mermaid
flowchart LR
    CppSource[*.cpp] -->|Emscripten| Wasm[*.wasm + .js glue]
    Wasm --> Store(src/wasm/)
    CI( GitHub Action ) -->|cache| Emscripten
CI step build-wasm caches ~/.emscripten_cache to speed up.

3.1 Emscripten Flags
bash
Copy
Edit
emcc kalman.cpp \
  -O3 -s WASM=1 \
  -s MODULARIZE=1 -s EXPORT_NAME="createKalmanModule" \
  -s ALLOW_MEMORY_GROWTH \
  -s EXPORTED_FUNCTIONS="['_kf_create','_kf_update','_kf_destroy']" \
  -o kalman.js
4 Runtime Loading Strategy
Step	Detail
1	Lazy import: import(/* webpackChunkName: "kalman" */ './kalman.js')
2	createKalmanModule() returns a Promise Module
3	Module cached in a singleton modulePromise
4	Worker thread calls exported C functions via Module._funcName
5	WebAssembly.Memory growth allowed (64 MB max cap)

SharedArrayBuffer is disabled until COOP/COEP rollout.

5 Plugin Interface
ts
Copy
Edit
export interface FilterPlugin {
  name: string;
  init(params: Record<string, any>): Promise<Handle>;
  update(handle: Handle, input: number[]): Promise<number[]>;
  destroy(handle: Handle): Promise<void>;
}
Each plugin directory exports plugin.ts implementing the interface; the JS glue is auto-generated by Emscripten.

6 Memory Management Guidelines
Pattern	Rule
malloc	Only inside plugin wrapper; free in destroy
Typed arrays	Use HEAPF64.subarray(ptr/8, ptr/8 + len)
Large buffers	Reuse same pointer across frames to avoid GC

7 Performance Benchmarks
Plugin	Avg time (ms)	Memo
Kalman	0.32 ms per 33 pts	MacBook M1 Chrome
Low-pass	0.18 ms	“”

CI runs npm run bench:wasm on push; fails if > 1.2× regression.

8 Open Issues / TODO
 Investigate SIMD.js and -msimd128 for Kalman matrix ops

 Explore SharedArrayBuffer zero-copy between Worker & UI

9 Revision History
Date	Version	Notes
2025-05-09	0.1	Initial skeleton drafted